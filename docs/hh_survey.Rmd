---
title: "Household Survey Processing"
output: html_document
date: "2023-05-16"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(dplyr.summarise.inform = FALSE)
options(scipen = 999)

library(tidyverse)
library(readxl)
```

```{r, include=FALSE}
hh <- read_csv("data/_private/hh_survey/input/AddonHH_OahuV2.csv")
per <- read_csv(
  "data/_private/hh_survey/input/AddonPER_OahuV2.csv",
  col_types = cols(SCHTYP_O = col_character())
)
per_driver <- read_excel("data/_private/hh_survey/input/Oahu_PER_DRIVER.xlsx")
per <- per %>%
  left_join(per_driver, c("HOUSEID", "PERSONID"))
trip <- read_csv("data/_private/hh_survey/input/AddonTRIP_OahuV2.csv")
```

```{r}
translate_table <- function(tbl){
  equiv_tbl <- read_csv("data/_private/hh_survey/input/equiv_table.csv")
  
  variables <- unique(equiv_tbl$VARIABLE)
  col_names <- colnames(tbl)
  for (variable in variables) {
    if (!(variable %in% col_names)) next
    
    tmp <- equiv_tbl %>%
      filter(VARIABLE == variable) %>%
      select(CODE, EQUIV)

    tbl <- tbl %>%
      rename(temp = variable) %>%
      left_join(tmp, by = c("temp" = "CODE")) %>%
      mutate(temp = ifelse(is.na(EQUIV), temp, EQUIV)) %>%
      select(-EQUIV) %>%
      rename(!!variable := temp)
  }
  return(tbl)
}
```

```{r, include=FALSE}
translate_hh <- translate_table(hh)
translate_per <- translate_table(per)
translate_trip <- translate_table(trip)

# also change the ONTD_P fields in the trip table
trip_fix_ontd <- translate_trip %>%
  mutate(across(ONTD_P1:ONTD_P15, ~ifelse(. == 1, 1, 0)))
```

# Checking the survey

```{r}

trip_fix_ontd %>%
  group_by(LOOP_TRIP) %>%
  summarize(count = n())

trip_fix_ontd %>%
  group_by(TRAVDAY) %>%
  summarize(count = n())

translate_hh %>%
  group_by(FLAG100) %>%
  summarize(count = n())

trip_fix_ontd %>%
  group_by(HOUSEID, PERSONID) %>%
  mutate(check = ifelse(ORIGIN_LOCTYPE == "Home", 1, 0)) %>%
  summarize(home_count = sum(check))

```

# Geocoding

```{r, include=FALSE}
hh_pts <- hh %>%
  mutate(unique_id = paste(CONFIRMEDHOME_LONGITUDE, CONFIRMEDHOME_LATITUDE, sep = "_")) %>%
  select(
    unique_id,
    longitude = CONFIRMEDHOME_LONGITUDE,
    latitude = CONFIRMEDHOME_LATITUDE
  )
per_pts <- bind_rows(
  per %>%
    mutate(unique_id = paste(WORKADDRESS_LON, WORKADDRESS_LAT, sep = "_")) %>%
    select(unique_id, longitude = WORKADDRESS_LON, latitude = WORKADDRESS_LAT),
  per %>%
    mutate(unique_id = paste(SCHOOLADDRESS_LON, SCHOOLADDRESS_LAT, sep = "_")) %>%
    select(unique_id, longitude = SCHOOLADDRESS_LON, latitude = SCHOOLADDRESS_LAT)
)
trip_pts <- bind_rows(
  trip %>%
    mutate(unique_id = paste(ORIGIN_LON, ORIGIN_LAT, sep = "_")) %>%
    select(unique_id, longitude = ORIGIN_LON, latitude = ORIGIN_LAT),
  trip %>%
    mutate(unique_id = paste(DESTINATION_LON, DESTINATION_LAT, sep = "_")) %>%
    select(unique_id, longitude = DESTINATION_LON, latitude = DESTINATION_LAT)
)

# Use this table in TransCAD to geocode points to TAZs then read back in
to_geocode <- bind_rows(hh_pts, per_pts, trip_pts) %>%
  group_by(unique_id) %>%
  slice(1)
write_csv(to_geocode, "data/_private/hh_survey/output/to_geocode.csv")
geocoded_pts <- read_csv("data/_private/hh_survey/output/geocoded_points.csv") %>%
  select(unique_id, TAZ)

hh_with_tazs <- translate_hh %>%
  mutate(unique_id = paste(CONFIRMEDHOME_LONGITUDE, CONFIRMEDHOME_LATITUDE, sep = "_")) %>%
  left_join(geocoded_pts, by = "unique_id") %>%
  rename(HomeTAZ = TAZ) %>%
  select(-unique_id)

per_with_taz <- translate_per %>%
  mutate(unique_id = paste(WORKADDRESS_LON, WORKADDRESS_LAT, sep = "_")) %>%
  left_join(geocoded_pts, by = "unique_id") %>%
  rename(WorkTAZ = TAZ) %>%
  mutate(unique_id = paste(SCHOOLADDRESS_LON, SCHOOLADDRESS_LAT, sep = "_")) %>%
  left_join(geocoded_pts, by = "unique_id") %>%
  rename(SchoolTAZ = TAZ) %>%
  select(-unique_id)

trip_with_taz <- trip_fix_ontd %>%
  mutate(unique_id = paste(ORIGIN_LON, ORIGIN_LAT, sep = "_")) %>%
  left_join(geocoded_pts, by = "unique_id") %>%
  rename(OriginTAZ = TAZ) %>%
  mutate(unique_id = paste(DESTINATION_LON, DESTINATION_LAT, sep = "_")) %>%
  left_join(geocoded_pts, by = "unique_id") %>%
  rename(DestinationTAZ = TAZ) %>%
  select(-unique_id) %>%
  arrange(HOUSEID, PERSONID, TRIPID)
```

# Household Structure

```{r}
# one-hot person variables
per_wrk_stat <- per_with_taz %>%
  mutate(
    WAdult = ifelse(WORKER == "Worker" & R_AGE > 17, 1, 0),
    NWAdult = ifelse(WORKER != "Worker" & R_AGE > 17, 1, 0),
    Kid = ifelse(R_AGE < 18, 1, 0),
    PreSch = ifelse(R_AGE < 6, 1, 0),
    Senior = ifelse(R_AGE > 75, 1, 0),
    WORKER = case_when(
      WORKER == "Worker" & EMPLOYMENT2 >= 32 ~ "FullTime",
      WORKER == "Worker" & EMPLOYMENT2 < 32 ~ "PartTime",
      TRUE ~ WORKER
    )
  )

hhstructure <- per_wrk_stat %>%
  group_by(HOUSEID) %>%
  summarise(
    WAdults = sum(WAdult), NWAdults = sum(NWAdult), HHKids = sum(Kid), 
    HHPreSchs = sum(PreSch), HHSeniors = sum(Senior)
  ) %>%
  mutate(HHStructure = paste0("HH_", WAdults, NWAdults, HHKids))

hh_with_structure <- hh_with_tazs %>%
  left_join(hhstructure, by = "HOUSEID")
```


# Convert to model modes

```{r}
# create start/end time fields that can be subtracted
convert_modes <- trip_with_taz %>%
  mutate(
    mode_model = case_when(
      TRPTRANS == "auto" & NUMONTRP == 1 ~ "sov",
      TRPTRANS == "auto" & NUMONTRP == 2 ~ "hov2",
      TRPTRANS == "auto" & NUMONTRP >= 3 ~ "hov3",
      TRUE ~ TRPTRANS
    ),
    start_mins = (STRTTIME %/% 100 * 60) + STRTTIME %% 100,
    end_mins = (ENDTIME %/% 100 * 60) + ENDTIME %% 100
  )
```


# ID Tours

```{r}
# Split 'school' purpose into K12 and Univ based on student status
split_k12_univ <- convert_modes %>%
  left_join(
    per_wrk_stat %>%
      select(HOUSEID, PERSONID, STUDE),
    by = c("HOUSEID", "PERSONID")
  ) %>%
  mutate(
    WHYTO = case_when(
      WHYTO != "School" ~ WHYTO,
      STUDE == "K-12th grade including GED" ~ "K12",
      STUDE == "Full-time college or university" ~ "Univ",
      STUDE == "Part-time college or university" ~ "Univ",
      STUDE == "Vocation/Technical/Trade School" ~ "Univ",
      TRUE ~ "Other"
    )
  )

id_tours <- split_k12_univ %>%
  filter(LOOP_TRIP == "Not a loop trip") %>%
  arrange(HOUSEID, PERSONID, TRIPID) %>%
  group_by(HOUSEID, PERSONID) %>%
  mutate(
    tour_start = case_when(
      TRIPID == 1 ~ 1,
      ORIGIN_LOCTYPE == "Home" ~ 1,
      ORIGIN_LOCTYPE == "Other" & WHYFROM == "Home" ~ 1,
      TRUE ~ 0
    ),
    tour_num = cumsum(tour_start)
  ) %>%
  group_by(HOUSEID, PERSONID, tour_num) %>%
  mutate(
    tour_type = case_when(
      "Work" %in% WHYTO ~ "Work",
      "Univ" %in% WHYTO ~ "Univ",
      "K12" %in% WHYTO ~ "K12",
      "Shopping" %in% WHYTO ~ "Shop",
      TRUE ~ "Other"
    ),
    tour_id = paste(HOUSEID, PERSONID, tour_num, sep = "_")
  )


# Mark tour anchor and intermediate stops
mark_anchor <- id_tours %>%
  mutate(
    temp_dwel = ifelse(DESTINATION_LOCTYPE == "Home", 0, DWELTIME),
    temp_dwel = ifelse(sum(temp_dwel) == 0 & TRIPID == 1, 1, temp_dwel),
    anchor = ifelse(temp_dwel == max(temp_dwel), 100, 0),
    anchor = case_when(
      WHYTO == "Work" ~ anchor + 3,
      WHYTO == "Univ" ~ anchor + 2,
      WHYTO == "K12" ~ anchor + 2,
      TRUE ~ anchor
    ),
    anchor = ifelse(anchor == max(anchor), 1, 0),
    anchor_taz = ifelse(anchor == max(anchor), DestinationTAZ, 0),
    anchor_dwell = ifelse(anchor == max(anchor), DWELTIME, 0),
    check = cumsum(anchor),
    anchor = ifelse(check > 1, 0, anchor),
    int_stop = case_when(
      anchor == 1 ~ 0,
      TRIPID == 1 ~ 0,
      TRIPID == max(TRIPID) ~ 0,
      TRUE ~ 1
    ),
    # check == 0 means the stop is before anchor
    int_stop_fwd = ifelse(check == 0, int_stop, 0),
    int_stop_ret = ifelse(check == 1, int_stop, 0)
  )

id_tour_mode <- mark_anchor %>%
  mutate(
    primary_mode = case_when(
      "rail" %in% mode_model ~ "rail",
      "school_bus" %in% mode_model ~ "school_bus",
      "bus" %in% mode_model ~ "bus",
      "taxi" %in% mode_model ~ "taxi",
      "tnc" %in% mode_model ~ "tnc",
      "trolley" %in% mode_model ~ "trolley",
      "hov3" %in% mode_model ~ "hov3",
      "hov2" %in% mode_model ~ "hov2",
      "sov" %in% mode_model ~ "sov",
      "bike" %in% mode_model ~ "bike",
      "walk" %in% mode_model ~ "walk",
      TRUE ~ "other"
    ),
    temp = ifelse(mode_model == primary_mode, NA, mode_model),
    secondary_mode = case_when(
      "rail" %in% temp ~ "rail",
      "school_bus" %in% temp ~ "school_bus",
      "taxi" %in% temp ~ "taxi",
      "tnc" %in% temp ~ "tnc",
      "trolley" %in% temp ~ "trolley",
      "hov3" %in% temp ~ "hov3",
      "hov2" %in% temp ~ "hov2",
      "sov" %in% temp ~ "sov",
      "bike" %in% temp ~ "bike",
      "walk" %in% temp ~ "walk",
      TRUE ~ ""
    )
  ) %>%
  #
  group_by(HOUSEID, PERSONID, tour_num, mode_model) %>%
  mutate(
    first_bus = ifelse(mode_model == "bus" & TRIPID == min(TRIPID), TRIPID, 0)
  ) %>%
  group_by(HOUSEID, PERSONID, tour_num) %>%
  mutate(
    # nearest_walk = case_when(
    #   primary_mode != "bus" ~ 0,
    #   TRIPID >= max(first_bus) ~ 0,
    #   mode_model != "walk" ~ 0,
    #   TRUE ~ TRIPID
    # ),
    # nearest_drive = case_when(
    #   primary_mode != "bus" ~ 0,
    #   TRIPID >= max(first_bus) ~ 0,
    #   !(mode_model %in% c("sov", "hov2", "hov3")) ~ 0,
    #   TRUE ~ TRIPID
    # )
    access_mode = ifelse(primary_mode == "bus",mode_model[TRIPID == max(first_bus) - 1], ""),
    PSGR_FLG_temp = ifelse(primary_mode == "bus",PSGR_FLG[TRIPID == max(first_bus) - 1], 0),
    access_mode = case_when(
      access_mode == "sov" ~ "pnr",
      access_mode %in% c("hov2", "hov3") & PSGR_FLG_temp == 2 ~ "pnr",
      access_mode %in% c("hov2", "hov3") ~ "knr",
      is.na(access_mode) ~ "walk",
      TRUE ~ access_mode
    )
  ) %>%
  select(-temp, PSGR_FLG_temp)

trip_mark_joint_tours <- id_tour_mode %>%
  mutate(
    hhmem_on_tour = NUMONTRP - NONHHCNT,
    joint_tour = ifelse(max(hhmem_on_tour > 1), 1, 0),
    joint_tour = max(joint_tour)
  )

# this table creates a field like "1_2" specifying that hh members 1 and 2
# were on this tour.
hh_pers_on_tour <- trip_mark_joint_tours %>%
  group_by(tour_id) %>%
  select(tour_id, ONTD_P1:ONTD_P15) %>%
  # if a HH member was on any trip of the tour, consider them as on the tour
  mutate(across(ONTD_P1:ONTD_P15, ~ ifelse(max(.) > 0, 1, 0))) %>%
  pivot_longer(cols = ONTD_P1:ONTD_P15, names_to = "PERSONID", values_to = "on_tour") %>%
  mutate(person_num = as.numeric(gsub("ONTD_P", "", PERSONID))) %>%
  filter(on_tour == 1) %>%
  group_by(tour_id, PERSONID) %>%
  slice(1) %>%
  pivot_wider(id_cols = tour_id, names_from = PERSONID, values_from = person_num) %>%
  unite("hh_perids_on_tour", ONTD_P1:ONTD_P11, na.rm = TRUE)

trip_add_pers_on_tour <- trip_mark_joint_tours %>%
  left_join(hh_pers_on_tour, by = "tour_id")

tour_file <- trip_add_pers_on_tour %>%
  group_by(tour_id) %>%
  summarize(
    HOUSEID = first(HOUSEID),
    PERSONID = first(PERSONID),
    tour_num = first(tour_num),
    tour_type = first(tour_type),
    tour_num = first(tour_num),
    num_trips = n(),
    joint_tour = first(joint_tour),
    hh_perids_on_tour = first(hh_perids_on_tour),
    anchor_taz = max(anchor_taz),
    anchor_dwell = max(anchor_dwell),
    anchor_time = ENDTIME[anchor == 1],
    int_stop_fwd = sum(int_stop_fwd),
    int_stop_ret = sum(int_stop_ret),
    primary_mode = first(primary_mode),
    access_mode = first(access_mode),
    secondary_mode = first(secondary_mode)
  ) %>%
  # Add household weight
  left_join(
    hh_with_structure %>%
      select(HOUSEID, weight = WTHHFIN5D_HI),
    by = "HOUSEID"
  )
```

# ID Subtours
When someone on a work tour leaves work/univ and returns

```{r}
work_address <- trip_add_pers_on_tour %>%
  filter(tour_type == "Work" & anchor == 1) %>%
  group_by(HOUSEID, PERSONID, tour_num) %>%
  summarize(work_address = first(DESTINATION_STREETADDR))
univ_address <- trip_add_pers_on_tour %>%
  filter(tour_type == "Univ" & anchor == 1) %>%
  group_by(HOUSEID, PERSONID, tour_num) %>%
  summarize(univ_address = first(DESTINATION_STREETADDR))
  
id_subtours <- trip_add_pers_on_tour %>%
  # subtours are only counted on work and university tours
  filter(tour_type %in% c("Work", "Univ")) %>%
  left_join(work_address, by = c("HOUSEID", "PERSONID", "tour_num")) %>%
  left_join(univ_address, by = c("HOUSEID", "PERSONID", "tour_num")) %>%
  group_by(HOUSEID, PERSONID, tour_num) %>%
  mutate(
    is_work = ifelse(work_address == DESTINATION_STREETADDR & WHYTO == "Work", 1, 0),
    is_work = ifelse(is.na(is_work), 0, is_work),
    is_univ = ifelse(univ_address == DESTINATION_STREETADDR & WHYTO == "Univ", 1, 0),
    is_univ = ifelse(is.na(is_univ), 0, is_univ),
    is_workuniv = pmax(is_work, is_univ),
    is_workuniv_cume = cumsum(is_workuniv),
    subtour_start = ifelse(is_workuniv == 1 & max(is_workuniv_cume) > is_workuniv_cume, 1, 0),
    subtour_start = lag(subtour_start),
    subtour_start = ifelse(is.na(subtour_start), 0, subtour_start),
    subtour_end = ifelse(is_workuniv == 1 & is_workuniv_cume > 1, 1, 0),
    start_cume = cumsum(subtour_start),
    end_cume = cumsum(subtour_end),
    start_cume = ifelse(start_cume == end_cume & start_cume == lag(end_cume), 0 , start_cume),
    start_cume = ifelse(is.na(start_cume), 0, start_cume),
    subtour_num = start_cume
  )

subtours <- id_subtours %>%
  filter(subtour_num > 0) %>%
  group_by(tour_id, HOUSEID, subtour_num) %>%
  # Subtours that go to other work locations or university are not considered
  mutate(subtour_purp = nth(DESTINATION_LOCTYPE, 1)) %>%
  filter(!(subtour_purp %in% c("Work", "Univ"))) %>%
  summarize(
    subtour_duration = max(end_mins) - min(start_mins),
    subtour_start_hr = min(STRTTIME %/% 100),
    # subtour_purp = first(subtour_purp),
    primary_mode = first(primary_mode)
  ) %>%
  # Add household weight
  left_join(
    hh_with_structure %>%
      select(HOUSEID, weight = WTHHFIN5D_HI),
    by = "HOUSEID"
  ) %>%
  select(-HOUSEID)
```


```{r}
tours_by_hh <- tour_file %>%
  group_by(HOUSEID, PERSONID, tour_type) %>%
  summarize(count = n()) %>%
  pivot_wider(
    id_cols = c(HOUSEID, PERSONID), names_from = tour_type, 
    values_from = count, values_fill = 0
  ) %>%
  mutate(WorkersThatDay = ifelse(Work > 0, 1, 0)) %>%
  group_by(HOUSEID) %>%
  summarize(across(Other:WorkersThatDay, ~ sum(.x))) %>%
  rename_with(~ paste0(.x, "_tours"), Other:Univ)

hh_add_tours <- hh_with_structure %>%
  left_join(tours_by_hh, by = "HOUSEID") %>%
  mutate(across(Other_tours:WorkersThatDay, ~replace_na(.x, 0))) %>%
  relocate(WorkersThatDay, .after = WAdults) %>%
  mutate(
    BasicPattern = paste0(
      "P_",
      WorkersThatDay,
      NUMADLT - WorkersThatDay, # adults not working that day,
      HHKids
    )
  )
```

## Add tour summary to person file

```{r}
tours_by_per <- tour_file %>%
  group_by(HOUSEID, PERSONID, tour_type) %>%
  summarize(count = n()) %>%
  pivot_wider(
    id_cols = HOUSEID:PERSONID, names_from = tour_type, 
    values_from = count, values_fill = 0
  ) %>%
  rename_with(~ paste0(.x, "_tours"), Other:Univ)

per_add_tour_counts <- per_wrk_stat %>%
  left_join(hh_with_tazs, by = "HOUSEID") %>%
  left_join(tours_by_per, by = c("HOUSEID", "PERSONID")) %>%
  mutate(across(Other_tours:Univ_tours, ~replace_na(.x, 0)))
```

## Calibration Target Creation

```{r}
# Auto ownership
auto_own <- hh_add_tours %>%
  mutate(HHVEHCNT = ifelse(HHVEHCNT > 4, 4, HHVEHCNT)) %>%
  group_by(HHVEHCNT) %>%
  summarize(weight = sum(WTHHFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  rename(Alternative = HHVEHCNT) %>%
  select(-weight)

# driver's license
drivers <- per_add_tour_counts %>%
  # don't filter bc the choice model is applied to the full pop
  # filter(R_AGE >= 17) %>%
  group_by(DRIVER) %>%
  summarize(weight = sum(WTHHFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  rename(Alternative = DRIVER) %>%
  select(-weight)

# Daycare status
daycare <- per_add_tour_counts %>%
  filter(R_AGE <= 5 & SCHOOL1 != "unknown") %>%
  group_by(SCHOOL1) %>%
  summarize(weight = sum(WTHHFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  rename(Alternative = SCHOOL1) %>%
  select(-weight)

# University status
university <- per_add_tour_counts %>%
  filter(R_AGE >= 18 & SCHOOL1 != "unknown") %>%
  group_by(SCHOOL1) %>%
  summarize(weight = sum(WTHHFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  rename(Alternative = SCHOOL1) %>%
  select(-weight)

# Full/Part time
worker_cat <- per_add_tour_counts %>%
  filter(WORKER %in% c("FullTime", "PartTime")) %>%
  group_by(WORKER) %>%
  summarize(weight = sum(WTHHFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  rename(Alternative = WORKER) %>%
  select(-weight)

# Remote work %
remote_work <- per_add_tour_counts %>%
  # mutate(remote_worker = ifelse(WKFMHM22 > 1, 1, 0)) %>%
  mutate(remote_worker = case_when(
    WKFMHM22 == 2 ~ 1.5/5, # reported 1-2 days a week
    WKFMHM22 == 3 ~ 3.5/5, # reported 3-4 days a week
    WKFMHM22 == 4 ~ 5/5,   # reported 5 days a week
    TRUE ~ 0
  )) %>%
  group_by(OATYP_JOB1, remote_worker) %>%
  summarize(weight = sum(WTHHFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  rename(Alternative = OATYP_JOB1) %>%
  filter(remote_worker == 1, Alternative != "skip") %>%
  select(-weight, -remote_worker)

# Days worked per week not provided. Field "EMPLOYMENT2" gives hours
# worked per week, but that can't be translated into days. (e.g. 4 10s vs 5 8s)

# mandatory tour frequency
tour_frequency <- tour_file %>%
  group_by(HOUSEID, PERSONID, tour_type) %>%
  summarize(
    count = n(), 
    weight = sum(weight, na.rm = TRUE)
  ) %>%
  mutate(count = ifelse(count > 2, 2, count)) %>%
  group_by(tour_type, count) %>%
  summarize(weight = sum(weight)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight) %>%
  pivot_wider(names_from = tour_type, values_from = target_pct) %>%
  rename(Alternative = count)

# mandatory tour mode shares
mode_choice <- tour_file %>%
  # # Add worker status
  # left_join(
  #   per_add_tour_counts %>%
  #     select(HOUSEID, PERSONID, WORKER),
  #   by = c("HOUSEID", "PERSONID")
  # ) %>%
  mutate(
    # tour_type = case_when(
    #   tour_type != "Work" ~ tour_type,
    #   WORKER == "FullTime" ~ "Work (FT)",
    #   TRUE ~ "Work (PT)"
    # ),
    primary_mode = ifelse(primary_mode %in% c("hov2", "hov3"), "hov", primary_mode),
    primary_mode = ifelse(
      access_mode != "",
      paste0(access_mode, "_", primary_mode),
      primary_mode
    )
  ) %>%
  group_by(tour_type, primary_mode) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight) %>%
  pivot_wider(names_from = tour_type, values_from = target_pct) %>%
  # arrange(desc(`Work (FT)`)) %>%
  arrange(desc(Work)) %>%
  # relocate(`Work (FT)`:`Work (PT)`, .after = primary_mode) %>%
  relocate(Other, .after = Univ)

# Mandatory time of day
tod <- tour_file %>%
  # Add worker status
  left_join(
    per_add_tour_counts %>%
      select(HOUSEID, PERSONID, WORKER),
    by = c("HOUSEID", "PERSONID")
  ) %>%
  mutate(
    tour_type = case_when(
      tour_type != "Work" ~ tour_type,
      WORKER == "FullTime" ~ "Work (FT)",
      TRUE ~ "Work (PT)"
    ),
    hour = anchor_time %/% 100
  ) %>%
  group_by(tour_type, hour) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight) %>%
  pivot_wider(names_from = tour_type, values_from = target_pct) %>%
  arrange(hour) %>%
  rename(Alternative = hour)

# Mandatory activity duration
activity_duration <- tour_file %>%
  # Add worker status
  left_join(
    per_add_tour_counts %>%
      select(HOUSEID, PERSONID, WORKER),
    by = c("HOUSEID", "PERSONID")
  ) %>%
  mutate(
    tour_type = case_when(
      tour_type != "Work" ~ tour_type,
      WORKER == "FullTime" ~ "Work (FT)",
      TRUE ~ "Work (PT)"
    ),
    anchor_dwell = anchor_dwell %/% 60,
    anchor_dwell = ifelse(anchor_dwell > 15, 15, anchor_dwell)
  ) %>%
  filter(anchor_dwell >= 0) %>%
  group_by(tour_type, anchor_dwell) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 2)) %>%
  select(-weight) %>%
  pivot_wider(names_from = tour_type, values_from = target_pct) %>%
  arrange(anchor_dwell) %>%
  rename(Alternative = anchor_dwell)

# Intermediate stop frequency
intermediate_freq <- tour_file %>%
  mutate(
    int_stop_fwd = ifelse(int_stop_fwd > 1, 1, int_stop_fwd),
    int_stop_ret = ifelse(int_stop_ret > 1, 1, int_stop_ret),
    Alternative = paste0(int_stop_fwd, "_", int_stop_ret)
  ) %>%
  group_by(tour_type, Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight) %>%
  pivot_wider(names_from = tour_type, values_from = target_pct)

# Intermediate stop duration
int_stop_duration <- trip_add_pers_on_tour %>%
  filter(int_stop == 1, DWELTIME <= 180) %>%
  mutate(Alternative = case_when(
    DWELTIME <= 15 ~ "0 to 15",
    DWELTIME <= 30 ~ "15 to 30",
    DWELTIME <= 45 ~ "30 to 45",
    DWELTIME <= 60 ~ "45 to 60",
    DWELTIME <= 75 ~ "60 to 75",
    DWELTIME <= 90 ~ "75 to 90",
    DWELTIME <= 105 ~ "90 to 105",
    DWELTIME <= 120 ~ "105 to 120",
    TRUE ~ "120 to 180"
  )) %>%
  # add this just to make sorting the table easier
  mutate(ID = case_when(
    DWELTIME <= 15 ~ 1,
    DWELTIME <= 30 ~ 2,
    DWELTIME <= 45 ~ 3,
    DWELTIME <= 60 ~ 4,
    DWELTIME <= 75 ~ 5,
    DWELTIME <= 90 ~ 6,
    DWELTIME <= 105 ~ 7,
    DWELTIME <= 120 ~ 8,
    TRUE ~ 9
  )) %>%
  group_by(tour_type, Alternative) %>%
  summarize(ID = first(ID), weight = sum(WTTRDFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight) %>%
  pivot_wider(names_from = tour_type, values_from = target_pct) %>%
  arrange(ID) %>%
  select(-ID)

# subtour frequency
tour_add_subtour <- tour_file %>%
  left_join(
    subtours %>%
      group_by(tour_id) %>%
      summarize(subtour_count = n()),
    by = "tour_id"
  ) %>%
  mutate(subtour_count = ifelse(is.na(subtour_count), 0, subtour_count))
subtour_freq <- tour_add_subtour %>%
  filter(tour_type %in% c("Work", "Univ")) %>%
  group_by(subtour_count) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight)

# subtour duration
subtour_duration <- subtours %>%
  mutate(
    Alternative = case_when(
      subtour_duration < 30 ~ "0 - 30",
      subtour_duration < 60 ~ "30 - 60",
      subtour_duration < 90 ~ "60 - 90",
      subtour_duration < 120 ~ "90 - 120",
      TRUE < 150 ~ "120 - 150"
    ),
    ID = case_when(
      subtour_duration < 30 ~ 1,
      subtour_duration < 60 ~ 2,
      subtour_duration < 90 ~ 3,
      subtour_duration < 120 ~ 4,
      TRUE < 150 ~ 5
    )
  ) %>%
  group_by(Alternative, ID) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight) %>%
  arrange(ID) %>%
  select(-ID)

# subtour mode
subtour_mode <- subtours %>%
  group_by(primary_mode) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight)

# subtour tod
subtour_tod <- subtours %>%
  group_by(subtour_start_hr) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight)
  
```

# NonMandatory Tours

```{r}
# While mandatory tours are modeled as personal choices, NM are modeled as
# household choices. This means repeated tour records (logged in the survey by
# two+ people who traveled together) must be removed.

# create a tour id that is unique to the household.
trip_add_hh_tour_id <- trip_add_pers_on_tour %>%
  mutate(hh_tour_id = paste(
    HOUSEID,
    first(ORIGIN_LOC),
    first(STRTTIME),
    last(ENDTIME),
    first(hh_perids_on_tour),
    sep = "_")
  ) %>%
  # remove PUDO tours from the table. These are generally taking kids to school
  # and are handled separately by the model.
  group_by(hh_tour_id) %>%
  mutate(is_pudo = ifelse("PUDO" %in% WHYTO, 1, 0)) %>%
  filter(is_pudo == 0)
  

# Joint tours (nonmandatory)
joint_comp <- trip_add_hh_tour_id %>%
  filter(!(tour_type %in% c("Work", "Univ", "K12")), joint_tour == 1) %>%
  group_by(hh_tour_id) %>%
  # make sure that everyone on any part of the tour is listed for all trips
  # in the tour before taking the first trip record.
  mutate(across(ONTD_P1:ONTD_P15, ~ ifelse(max(.) > 0, 1, 0))) %>%
  slice(1) %>%
  ungroup() %>%
  select(HOUSEID, hh_tour_id, tour_type, ONTD_P1:ONTD_P15) %>%
  pivot_longer(cols = ONTD_P1:ONTD_P15, names_to = "PERSONID", values_to = "on_trip") %>%
  mutate(PERSONID = as.double(gsub("ONTD_P", "", PERSONID))) %>%
  filter(on_trip == 1) %>%
  # # only keep the first instance of a person appearing on the tour to avoid
  # # double counting
  # group_by(tour_id, PERSONID) %>%
  # slice(1) %>%
  left_join(
    translate_per %>%
      select(HOUSEID, PERSONID, R_AGE),
    by = c("HOUSEID", "PERSONID")
  ) %>%
  mutate(type = ifelse(R_AGE > 17, "A", "K")) %>%
  group_by(HOUSEID, hh_tour_id, tour_type, type) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  pivot_wider(
    id_cols = HOUSEID:tour_type, names_from = type, values_from = count,
    values_fill = 0
  ) %>%
  ungroup() %>%
  filter(A > 0) %>%
  mutate(
    A = ifelse(A > 2, 2, A),
    K = ifelse(A == 1 & K > 3, 3, K),
    K = ifelse(A == 2 & K > 1, 1, K)
  ) %>%
  # check against total household size and flag those where all HH members
  # traveled
  left_join(
    translate_hh %>% select(HOUSEID, HHSIZE),
    by = "HOUSEID"
  ) %>%
  mutate(Alternative = case_when(
    A + K == HHSIZE ~ "All",
    TRUE ~ paste0("A", A, "K", K)
  )) %>%
  # Add household weight
  left_join(
    hh_with_structure %>%
      select(HOUSEID, weight = WTHHFIN5D_HI),
    by = "HOUSEID"
  ) 

joint_comp_other <- joint_comp %>%
  filter(tour_type == "Other") %>%
  group_by(Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

joint_comp_shop <- joint_comp %>%
  filter(tour_type == "Shop") %>%
  group_by(Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

# joint activity duration
joint_dur <- trip_add_hh_tour_id %>%
  filter(!(tour_type %in% c("Work", "Univ", "K12")), joint_tour == 1) %>%
  group_by(HOUSEID, hh_tour_id) %>%
  summarize(
    anchor_dwell = max(anchor_dwell),
    tour_type = first(tour_type)
  ) %>%
  mutate(Alternative = case_when(
    anchor_dwell < 30 ~ "0 - 30",
    anchor_dwell < 60 ~ "30 - 60",
    anchor_dwell < 90 ~ "60 - 90",
    anchor_dwell < 120 ~ "90 - 120",
    anchor_dwell < 150 ~ "120 - 150",
    anchor_dwell < 180 ~ "150 - 180",
    anchor_dwell < 210 ~ "180 - 210",
    anchor_dwell < 240 ~ "210 - 240",
    anchor_dwell < 270 ~ "240 - 270",
    anchor_dwell < 300 ~ "270 - 300",
    TRUE ~ "300 - 330"
  )) %>%
  # Add household weight
  left_join(
    hh_with_structure %>%
      select(HOUSEID, weight = WTHHFIN5D_HI),
    by = "HOUSEID"
  ) 

joint_dur_other <- joint_dur %>%
  filter(tour_type == "Other" & anchor_dwell < 330) %>%
  group_by(Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

joint_dur_shop <- joint_dur %>%
  filter(tour_type == "Shop" & anchor_dwell < 180) %>%
  group_by(Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))
  
# Joint tour frequency
joint_freq <- trip_add_hh_tour_id %>%
  filter(!(tour_type %in% c("Work", "Univ", "K12")), joint_tour == 1) %>%
  group_by(HOUSEID, hh_tour_id) %>%
  summarize(tour_type = first(tour_type)) %>%
  group_by(HOUSEID, tour_type) %>%
  summarize(count = n ()) %>%
  mutate(
    count = ifelse(count > 2, 2, count),
    count = ifelse(tour_type == "Shop", min(1, count), count)
  ) %>%
  pivot_wider(id_cols = HOUSEID, names_from = tour_type, values_from = count, values_fill = 0) %>%
  mutate(Alternative = paste0("o", Other, "s", Shop)) %>%
  left_join(
    hh_with_structure %>%
      select(HOUSEID, weight = WTHHFIN5D_HI),
    by = "HOUSEID"
  ) %>%
  group_by(Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

# Joint tour mc
joint_mc <- trip_add_hh_tour_id %>%
  filter(!(tour_type %in% c("Work", "Univ", "K12")), joint_tour == 1) %>%
  mutate(primary_mode = ifelse(primary_mode %in% c("hov2", "hov3"), "carpool", primary_mode)) %>%
  group_by(HOUSEID, hh_tour_id) %>%
  summarize(
    Alternative = first(primary_mode),
    tour_type = first(tour_type)
  ) %>%
  left_join(
    hh_with_structure %>%
      select(HOUSEID, weight = WTHHFIN5D_HI),
    by = "HOUSEID"
  ) 

joint_mc_other <- joint_mc %>%
  filter(tour_type == "Other") %>%
  group_by(Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

joint_mc_shop <- joint_mc %>%
  filter(tour_type == "Shop") %>%
  group_by(Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

# Joint tour start time
joint_tod <- trip_add_hh_tour_id %>%
  filter(!(tour_type %in% c("Work", "Univ", "K12")), joint_tour == 1) %>%
  mutate(
    anchor_time = first(ENDTIME[anchor == 1]),
    anchor_hr = anchor_time %/% 100
  ) %>%
  group_by(HOUSEID, hh_tour_id) %>%
  summarize(
    Alternative = first(anchor_hr),
    tour_type = first(tour_type)
  ) %>%
  left_join(
    hh_with_structure %>%
      select(HOUSEID, weight = WTHHFIN5D_HI),
    by = "HOUSEID"
  ) 

joint_tod_other <- joint_tod %>%
  filter(tour_type == "Other") %>%
  group_by(Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

joint_tod_shop <- joint_tod %>%
  filter(tour_type == "Shop") %>%
  group_by(Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

# Joint tour stop duration
joint_stop_dur <- trip_add_hh_tour_id %>%
  filter(!(tour_type %in% c("Work", "Univ", "K12")), joint_tour == 1) %>%
  filter(int_stop == 1, DWELTIME <= 180) %>%
  mutate(Alternative = case_when(
    DWELTIME <= 15 ~ "0 to 15",
    DWELTIME <= 30 ~ "15 to 30",
    DWELTIME <= 45 ~ "30 to 45",
    DWELTIME <= 60 ~ "45 to 60",
    DWELTIME <= 75 ~ "60 to 75",
    DWELTIME <= 90 ~ "75 to 90",
    DWELTIME <= 105 ~ "90 to 105",
    DWELTIME <= 120 ~ "105 to 120",
    TRUE ~ "120 to 180"
  )) %>%
  # add this just to make sorting the table easier
  mutate(ID = case_when(
    DWELTIME <= 15 ~ 1,
    DWELTIME <= 30 ~ 2,
    DWELTIME <= 45 ~ 3,
    DWELTIME <= 60 ~ 4,
    DWELTIME <= 75 ~ 5,
    DWELTIME <= 90 ~ 6,
    DWELTIME <= 105 ~ 7,
    DWELTIME <= 120 ~ 8,
    TRUE ~ 9
  )) 

joint_stop_dur_other <- joint_stop_dur %>%
  filter(tour_type == "Other") %>%
  group_by(tour_type, Alternative) %>%
  summarize(ID = first(ID), weight = sum(WTTRDFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight) %>%
  pivot_wider(names_from = tour_type, values_from = target_pct) %>%
  arrange(ID) %>%
  select(-ID)

joint_stop_dur_shop <- joint_stop_dur %>%
  filter(tour_type == "Shop") %>%
  group_by(tour_type, Alternative) %>%
  summarize(ID = first(ID), weight = sum(WTTRDFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight) %>%
  pivot_wider(names_from = tour_type, values_from = target_pct) %>%
  arrange(ID) %>%
  select(-ID)

# create a nonmandatory tour file
nm_tours <- trip_add_hh_tour_id %>%
  filter(!(tour_type %in% c("Work", "Univ", "K12"))) %>%
  group_by(HOUSEID, hh_tour_id) %>%
  summarize(
    tour_type = first(tour_type),
    int_stop_fwd = sum(int_stop_fwd), # this double counts but gets capped at 1
    int_stop_ret = sum(int_stop_ret),
    joint_tour = first(joint_tour),
    primary_mode = first(primary_mode),
    anchor_time = first(ENDTIME[anchor == 1]),
  ) %>%  
  mutate(
    anchor_hr = anchor_time %/% 100,
    int_stop_fwd = ifelse(int_stop_fwd > 1, 1, int_stop_fwd),
    int_stop_ret = ifelse(int_stop_ret > 1, 1, int_stop_ret)
  ) %>%
  left_join(
    hh_with_structure %>%
      select(HOUSEID, weight = WTHHFIN5D_HI),
    by = "HOUSEID"
  )

# joint intermediate stop frequency
joint_stop_freq <- nm_tours %>%
  filter(joint_tour == 1) %>%
  mutate(
    Alternative = paste0(int_stop_fwd, "_", int_stop_ret)
  ) %>%
  group_by(tour_type, Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight) %>%
  pivot_wider(names_from = tour_type, values_from = target_pct)

# HH nm pattern choice
summary_tbl <- nm_tours %>%
  mutate(indiv_tour = ifelse(joint_tour == 0, 1, 0)) %>%
  group_by(HOUSEID) %>%
  summarize(
    joint_tours = sum(joint_tour),
    indiv_tours = sum(indiv_tour)
  ) 
hh_with_nm_pattern <- hh_add_tours %>%
  left_join(summary_tbl, by = "HOUSEID") %>%
  replace_na(list("joint_tours" = 0, "indiv_tours" = 0)) %>%
  mutate(nm_pattern = case_when(
    joint_tours + indiv_tours == 0 ~ "N",
    joint_tours >= 1 & indiv_tours == 0 ~ "J",
    joint_tours == 0 & indiv_tours >= 1 ~ "I",
    TRUE ~ "IJ"
  ))

nm_pattern_choice <- hh_with_nm_pattern %>%
  group_by(nm_pattern) %>%
  summarize(weight = sum(WTHHFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1))
  
```

```{r}
# Solo tours

# solo activity duration
solo_dur <- trip_add_hh_tour_id %>%
  filter(!(tour_type %in% c("Work", "Univ", "K12")), joint_tour == 0) %>%
  group_by(HOUSEID, hh_tour_id) %>%
  summarize(
    anchor_dwell = max(anchor_dwell),
    tour_type = first(tour_type)
  ) %>%
  mutate(Alternative = case_when(
    anchor_dwell < 30 ~ "0 - 30",
    anchor_dwell < 60 ~ "30 - 60",
    anchor_dwell < 90 ~ "60 - 90",
    anchor_dwell < 120 ~ "90 - 120",
    anchor_dwell < 150 ~ "120 - 150",
    anchor_dwell < 180 ~ "150 - 180",
    anchor_dwell < 210 ~ "180 - 210",
    anchor_dwell < 240 ~ "210 - 240",
    anchor_dwell < 270 ~ "240 - 270",
    anchor_dwell < 300 ~ "270 - 300",
    TRUE ~ "300 - 330"
  )) %>%
  # Add household weight
  left_join(
    hh_with_structure %>%
      select(HOUSEID, weight = WTHHFIN5D_HI),
    by = "HOUSEID"
  ) 

solo_dur_other <- joint_dur %>%
  filter(tour_type == "Other" & anchor_dwell < 330) %>%
  group_by(Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

solo_dur_shop <- joint_dur %>%
  filter(tour_type == "Shop" & anchor_dwell < 180) %>%
  group_by(Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

# solo tour frequency. these are person level targets and only applicable
# to people in households that make solo tours (have 'i' in the solo pattern)
summary_tbl <- tour_file %>%
  filter(!(tour_type %in% c("Work", "Univ", "K12")), joint_tour == 0) %>%
  select(HOUSEID, PERSONID, tour_type) %>%
  group_by(HOUSEID, PERSONID, tour_type) %>%
  summarize(count = n()) %>%
  pivot_wider(names_from = tour_type, values_from = count, values_fill = 0) %>%
  mutate(
    Other = ifelse(Other > 3, 3, Other),
    Shop = ifelse(Shop > 2, 2, Shop),
    Shop = ifelse(Other > 0, min(1, Shop), Shop),
    Alternative = paste0("O", Other, "S", Shop),
    Alternative = case_when(
      Alternative == "O0S1" ~ "S1",
      Alternative == "O0S2" ~ "S2",
      Alternative == "O1S0" ~ "O1",
      # Alternative == "O1S1" ~ "S1",
      Alternative == "O2S0" ~ "O2",
      Alternative == "O3S0" ~ "O3",
      Alternative == "O3S1" ~ "O2S1",
      TRUE ~ Alternative
    )
  )
solo_freq <- per_add_tour_counts %>%
  left_join(
    hh_with_nm_pattern %>%
      select(HOUSEID, hh_nm_pattern = nm_pattern),
    by = "HOUSEID"
  ) %>%
  filter(grepl("I", hh_nm_pattern)) %>%
  left_join(
    summary_tbl %>%
      select(HOUSEID, PERSONID, Alternative),
    by = c("HOUSEID", "PERSONID")
  ) %>%
  replace_na(list("Alternative" = "No Tours")) %>%
  group_by(Alternative) %>%
  summarize(weight = sum(WTHHFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

# solo mode choice
solo_mc <- nm_tours %>%
  filter(joint_tour == 0) %>%
  mutate(primary_mode = case_when(
    primary_mode %in% c("hov2", "hov3") ~ "carpool",
    primary_mode == "rail" ~ "other",
    primary_mode == "school_bus" ~ "other",
    primary_mode == "taxi" ~ "other",
    primary_mode == "tnc" ~ "other",
    TRUE ~ primary_mode
  )) 
solo_mc_other <- solo_mc %>%
  filter(tour_type == "Other") %>%
  group_by(primary_mode) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))
solo_mc_shop <- solo_mc %>%
  filter(tour_type == "Shop") %>%
  group_by(primary_mode) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

# solo tod
solo_tod_other <- nm_tours %>%
  filter(joint_tour == 0 & tour_type == "Other") %>%
  group_by(anchor_hr) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))
solo_tod_shop <- nm_tours %>%
  filter(joint_tour == 0 & tour_type == "Shop") %>%
  group_by(anchor_hr) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_share = round(weight / sum(weight) * 100, 1))

# Joint tour stop duration
solo_stop_dur <- trip_add_hh_tour_id %>%
  filter(!(tour_type %in% c("Work", "Univ", "K12")), joint_tour == 0) %>%
  filter(int_stop == 1, DWELTIME <= 180) %>%
  mutate(Alternative = case_when(
    DWELTIME <= 15 ~ "0 to 15",
    DWELTIME <= 30 ~ "15 to 30",
    DWELTIME <= 45 ~ "30 to 45",
    DWELTIME <= 60 ~ "45 to 60",
    DWELTIME <= 75 ~ "60 to 75",
    DWELTIME <= 90 ~ "75 to 90",
    DWELTIME <= 105 ~ "90 to 105",
    DWELTIME <= 120 ~ "105 to 120",
    TRUE ~ "120 to 180"
  )) %>%
  # add this just to make sorting the table easier
  mutate(ID = case_when(
    DWELTIME <= 15 ~ 1,
    DWELTIME <= 30 ~ 2,
    DWELTIME <= 45 ~ 3,
    DWELTIME <= 60 ~ 4,
    DWELTIME <= 75 ~ 5,
    DWELTIME <= 90 ~ 6,
    DWELTIME <= 105 ~ 7,
    DWELTIME <= 120 ~ 8,
    TRUE ~ 9
  )) 

solo_stop_dur_other <- solo_stop_dur %>%
  filter(tour_type == "Other") %>%
  group_by(tour_type, Alternative) %>%
  summarize(ID = first(ID), weight = sum(WTTRDFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight) %>%
  pivot_wider(names_from = tour_type, values_from = target_pct) %>%
  arrange(ID) %>%
  select(-ID)

solo_stop_dur_shop <- solo_stop_dur %>%
  filter(tour_type == "Shop") %>%
  group_by(tour_type, Alternative) %>%
  summarize(ID = first(ID), weight = sum(WTTRDFIN5D_HI, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight) %>%
  pivot_wider(names_from = tour_type, values_from = target_pct) %>%
  arrange(ID) %>%
  select(-ID)

# solo int stop frequency
solo_stop_freq <- nm_tours %>%
  filter(joint_tour == 0) %>%
  mutate(
    Alternative = paste0(int_stop_fwd, "_", int_stop_ret)
  ) %>%
  group_by(tour_type, Alternative) %>%
  summarize(weight = sum(weight, na.rm = TRUE)) %>%
  mutate(target_pct = round(weight / sum(weight) * 100, 1)) %>%
  select(-weight) %>%
  pivot_wider(names_from = tour_type, values_from = target_pct)
```



```{r, eval=FALSE}
# Outputs
write_csv(per_add_tour_counts, "data/_private/hh_survey/output/output_persons.csv", na = "")
write_csv(hh_with_nm_pattern, "data/_private/hh_survey/output/output_households.csv", na = "")
write_csv(tour_add_subtour, "data/_private/hh_survey/output/output_tours.csv", na = "")
write_csv(id_subtours, "data/_private/hh_survey/output/output_trips.csv", na = "")

# calibration targets
write_csv(auto_own, "data/_private/hh_survey/output/calibration_targets/auto_ownership.csv", na = "")
write_csv(drivers, "data/_private/hh_survey/output/calibration_targets/drivers.csv", na = "")
write_csv(daycare, "data/_private/hh_survey/output/calibration_targets/daycare.csv", na = "")
write_csv(university, "data/_private/hh_survey/output/calibration_targets/university.csv", na = "")
write_csv(worker_cat, "data/_private/hh_survey/output/calibration_targets/worker_cat.csv", na = "")
write_csv(remote_work, "data/_private/hh_survey/output/calibration_targets/remote_work.csv", na = "")
write_csv(remote_work, "data/_private/hh_survey/output/calibration_targets/remote_work.csv", na = "")
write_csv(tour_frequency, "data/_private/hh_survey/output/calibration_targets/tour_frequency.csv", na = "")
write_csv(mode_choice, "data/_private/hh_survey/output/calibration_targets/mode_choice.csv", na = "")
write_csv(tod, "data/_private/hh_survey/output/calibration_targets/time_of_day.csv", na = "")
write_csv(activity_duration, "data/_private/hh_survey/output/calibration_targets/activity_duration.csv", na = "")
write_csv(intermediate_freq, "data/_private/hh_survey/output/calibration_targets/intermediate_freq.csv", na = "")
write_csv(int_stop_duration, "data/_private/hh_survey/output/calibration_targets/int_stop_duration.csv", na = "")
write_csv(subtour_freq, "data/_private/hh_survey/output/calibration_targets/subtour_freq.csv", na = "")
write_csv(subtour_duration, "data/_private/hh_survey/output/calibration_targets/subtour_duration.csv", na = "")
write_csv(subtour_mode, "data/_private/hh_survey/output/calibration_targets/subtour_mode.csv", na = "")
write_csv(subtour_tod, "data/_private/hh_survey/output/calibration_targets/subtour_tod.csv", na = "")
write_csv(joint_comp_other, "data/_private/hh_survey/output/calibration_targets/joint_comp_other.csv", na = "")
write_csv(joint_comp_shop, "data/_private/hh_survey/output/calibration_targets/joint_comp_shop.csv", na = "")
write_csv(joint_dur_other, "data/_private/hh_survey/output/calibration_targets/joint_dur_other.csv", na = "")
write_csv(joint_dur_shop, "data/_private/hh_survey/output/calibration_targets/joint_dur_shop.csv", na = "")
write_csv(joint_freq, "data/_private/hh_survey/output/calibration_targets/joint_freq.csv", na = "")
write_csv(joint_mc_other, "data/_private/hh_survey/output/calibration_targets/joint_mc_other.csv", na = "")
write_csv(joint_mc_shop, "data/_private/hh_survey/output/calibration_targets/joint_mc_shop.csv", na = "")
write_csv(joint_tod_other, "data/_private/hh_survey/output/calibration_targets/joint_tod_other.csv", na = "")
write_csv(joint_tod_shop, "data/_private/hh_survey/output/calibration_targets/joint_tod_shop.csv", na = "")
write_csv(joint_stop_dur_other, "data/_private/hh_survey/output/calibration_targets/joint_stop_dur_other.csv", na = "")
write_csv(joint_stop_dur_shop, "data/_private/hh_survey/output/calibration_targets/joint_stop_dur_shop.csv", na = "")
write_csv(joint_stop_freq, "data/_private/hh_survey/output/calibration_targets/joint_stop_freq.csv", na = "")
write_csv(nm_pattern_choice, "data/_private/hh_survey/output/calibration_targets/nm_pattern_choice.csv", na = "")
write_csv(solo_dur_other, "data/_private/hh_survey/output/calibration_targets/solo_dur_other.csv", na = "")
write_csv(solo_dur_shop, "data/_private/hh_survey/output/calibration_targets/solo_dur_shop.csv", na = "")
write_csv(solo_freq, "data/_private/hh_survey/output/calibration_targets/solo_freq.csv", na = "")
write_csv(solo_mc_other, "data/_private/hh_survey/output/calibration_targets/solo_mc_other.csv", na = "")
write_csv(solo_mc_shop, "data/_private/hh_survey/output/calibration_targets/solo_mc_shop.csv", na = "")
write_csv(solo_tod_other, "data/_private/hh_survey/output/calibration_targets/solo_tod_other.csv", na = "")
write_csv(solo_tod_shop, "data/_private/hh_survey/output/calibration_targets/solo_tod_shop.csv", na = "")
write_csv(solo_stop_dur_other, "data/_private/hh_survey/output/calibration_targets/solo_stop_dur_other.csv", na = "")
write_csv(solo_stop_dur_shop, "data/_private/hh_survey/output/calibration_targets/solo_stop_dur_shop.csv", na = "")
```

